# 需求分析与总体设计

## 需求分析（覆盖全流程与模块）
- 目标：严格按《EduRisk-TabNet_plus.md》实现完整流程：数据→缺失指示m→MAF→TabNet（mask/prior/稀疏正则）→DM-GFS（组mask→特征mask/组多样性正则）→SASC（软停机/期望步数正则/可选early-exit）→Head（softmax或ordinal）→DACOS（代价矩阵/风险对齐训练/Bayes最小期望代价推理）→统一损失L→实验矩阵→图表清单→可复现性与工程策略。
- 约束：所有说明文字、注释、docstring、日志信息均为中文；功能实现必须可通过最小冒烟训练与绘图脚本。
- 输入：表格数据集，支持缺失值，标签为K类有序等级；支持特征分组信息。
- 输出：训练后的模型参数、评估指标、可解释性产物（组级与特征级mask统计）、图表与报告。

## 总体设计与流程
1. 数据层
   - 输入：原始特征x与标签y，缺失以空值或特殊标记存在。
   - 输出：填充后的特征x_hat、缺失指示m、可选的特征分组矩阵G。
2. MAF（缺失感知融合）
   - 输入：x_hat、m。
   - 输出：融合后的特征表示x_tilde，供TabNet编码器使用。
3. TabNet（mask/prior/稀疏正则）
   - 输入：x_tilde。
   - 输出：逐步决策特征d^(t)、上下文a^(t)、最终决策向量d_out。
4. DM-GFS（组mask→特征mask/组多样性正则）
   - 输入：x_tilde、组矩阵G、上一步上下文a^(t-1)。
   - 输出：组级mask m_g^(t)、特征级mask m_f^(t)，并产生L_group。
5. SASC（软停机/期望步数正则/可选early-exit）
   - 输入：各步决策特征d^(t)。
   - 输出：样本级权重alpha_{b,t}、聚合表示d_b，并产生L_step；推理可选early-exit。
6. Head（softmax或ordinal）
   - 输入：d_b或d_out。
   - 输出：类别分布p(y|x)。
7. DACOS（代价矩阵/风险对齐训练/Bayes最小期望代价推理）
   - 输入：p(y|x)、代价矩阵C。
   - 输出：风险对齐损失L_risk与推理期Bayes最小期望代价决策。
8. 统一损失L
   - L = L_base + λ_sparse L_sparse + λ_group L_group + λ_step L_step + λ_risk L_risk。
9. 实验矩阵
   - 主实验：完整模型。
   - 消融：逐模块叠加与交互消融。
10. 图表清单
   - 性能指标表、代价指标表、步数分布图、mask可解释性图、消融对比图。
11. 可复现性与工程策略
   - 固定随机种子、配置驱动、结果落盘、可重放训练。

## 模块接口与张量形状
- 记号约定：
  - 批大小B，特征维度D，组数G，类别数K，步数T，决策维度N_d。
- 数据层
  - 输入：x ∈ R^{B×D}（含缺失），y ∈ {0,…,K-1}^B。
  - 输出：x_hat ∈ R^{B×D}，m ∈ {0,1}^{B×D}，G ∈ {0,1}^{D×G}。
- MAF
  - 输入：x_hat、m。
  - 输出：x_tilde ∈ R^{B×D}。
- TabNet基础
  - 输入：x_tilde。
  - 每步输出：mask M^(t) ∈ [0,1]^{B×D}，决策特征d^(t) ∈ R^{B×N_d}，上下文a^(t) ∈ R^{B×N_a}。
  - 累积输出：d_out = Σ_t ReLU(d^(t))，形状R^{B×N_d}。
- DM-GFS
  - 输入：x_tilde、G、a^(t-1)。
  - 组级聚合：f_g = x_tilde · G，形状R^{B×G}。
  - 输出：m_g^(t) ∈ [0,1]^{B×G}，m_f^(t) ∈ [0,1]^{B×D}。
- SASC
  - 输入：d^(t)。
  - 输出：alpha_{b,t} ∈ [0,1]，聚合表示d_b ∈ R^{B×N_d}。
- Head
  - softmax：logits ∈ R^{B×K}，p ∈ R^{B×K}。
  - ordinal：阈值输出s ∈ R^{B×(K-1)}，累积概率q ∈ (0,1)^{B×(K-1)}，p ∈ R^{B×K}。
- DACOS
  - 输入：p ∈ R^{B×K}，代价矩阵C ∈ R^{K×K}。
  - 输出：风险R ∈ R^{B×K}，风险对齐损失L_risk。

## 训练与推理流程
- 训练流程
  1. 数据读取与填充，生成m与G。
  2. 经过MAF得到x_tilde。
  3. TabNet多步选择：在每步中由DM-GFS生成mask并更新prior。
  4. 通过SASC进行样本级加权，得到聚合表示。
  5. 通过Head输出p(y|x)。
  6. 计算L_base、L_sparse、L_group、L_step、L_risk并求和优化。
- 推理流程
  1. 与训练一致的MAF与TabNet前向。
  2. 若启用early-exit，依据期望风险下降阈值提前停止。
  3. 使用Bayes最小期望代价规则输出最终等级。

## 损失项定义
- L_base
  - softmax交叉熵或ordinal阈值损失。
- L_sparse
  - 对每步mask的稀疏正则，鼓励稀疏与可解释性。
- L_group
  - 相邻步组mask重叠惩罚，减少组内反复选择。
- L_step
  - 期望步数正则，鼓励更少的有效步数。
- L_risk
  - 基于代价矩阵与softmin风险的对齐损失。

## 评估指标定义
- 分类指标：Accuracy、Macro-F1、Weighted-F1。
- 序级指标：MAE、Quadratic Weighted Kappa。
- 代价指标：Expected Cost（按C计算）。
- 效率指标：平均步数E[T_b]，可选推理耗时。

## 实验设置与矩阵
- 主实验：完整EduRisk-TabNet配置。
- 消融矩阵：
  - Base TabNet
  - +MAF
  - +DM-GFS
  - +SASC
  - +DACOS
  - 全部模块
  - 交互消融：MAF×DM-GFS，SASC×DACOS。
- 对比基线：树模型、深度表格模型、序级与代价敏感基线。

## 图表清单与报告输出
- 主指标表：分类、序级与代价指标。
- 步数分布图：SASC有效步数统计。
- 组级与特征级mask可解释性图。
- 消融对比图与基线对比图。
- 报告需包含配置、随机种子、硬件与版本信息。

## 可复现性与工程策略
- 配置驱动：所有实验与绘图参数来自配置文件。
- 结果落盘：保存指标、日志、模型与图表。
- 固定随机种子与多次重复实验，报告均值与方差。
- 统一入口：训练与绘图脚本提供可追溯命令。
